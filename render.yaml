# Render Blueprint - Infrastructure as Code
# https://render.com/docs/blueprint-spec

services:
  # ============ Web Service ============
  - type: web
    name: remixify
    runtime: docker
    dockerfilePath: ./Dockerfile
    dockerContext: .
    repo: https://github.com/kwakubiney/remixify
    branch: master
    
    # Auto-deploy on push
    autoDeploy: true
    
    # Health check
    healthCheckPath: /health/
    
    # Scaling
    plan: starter
    numInstances: 1
    
    # Environment variables
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: main.settings.prod_settings
      - key: DJANGO_SECRET_KEY
        generateValue: true
      - key: SPOTIFY_CLIENT_ID
        sync: false
      - key: SPOTIFY_CLIENT_SECRET
        sync: false
      - key: REDIRECT_URI
        sync: false
      - key: SITE_ID
        value: "1"
      - key: DATABASE_URL
        sync: false  # Set in Render dashboard
      - key: REDIS_URL
        fromService:
          name: remixify-redis
          type: redis
          property: connectionString

  # ============ Celery Worker ============
  - type: worker
    name: remixify-celery
    runtime: docker
    dockerfilePath: ./Dockerfile
    dockerContext: .
    repo: https://github.com/kwakubiney/remixify
    branch: master
    autoDeploy: true
    
    # Override the Docker CMD for Celery
    dockerCommand: celery -A main worker -l info --concurrency=2
    
    plan: starter
    
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: main.settings.prod_settings
      - key: DJANGO_SECRET_KEY
        fromService:
          name: remixify
          type: web
          envVarKey: DJANGO_SECRET_KEY
      - key: SPOTIFY_CLIENT_ID
        sync: false
      - key: SPOTIFY_CLIENT_SECRET
        sync: false
      - key: REDIRECT_URI
        sync: false
      - key: SITE_ID
        value: "1"
      - key: DATABASE_URL
        sync: false  # Set in Render dashboard
      - key: REDIS_URL
        fromService:
          name: remixify-redis
          type: redis
          property: connectionString

  # ============ Redis ============
  - type: redis
    name: remixify-redis
    plan: starter
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []
