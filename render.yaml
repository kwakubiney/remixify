# Render Blueprint - Infrastructure as Code
# https://render.com/docs/blueprint-spec

services:
  # ============ Web Service ============
  - type: web
    name: remixify
    runtime: docker
    dockerfilePath: ./Dockerfile
    dockerContext: .
    repo: https://github.com/kwakubiney/remixify
    branch: master
    
    # Auto-deploy on push
    autoDeploy: true
    
    # Health check
    healthCheckPath: /health/
    
    # Scaling
    plan: starter  # or 'free' for testing
    numInstances: 1
    
    # Environment variables
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: main.settings.prod_settings
      - key: DJANGO_SECRET_KEY
        generateValue: true
      - key: SPOTIFY_CLIENT_ID
        sync: false  # Set manually in Render dashboard
      - key: SPOTIFY_CLIENT_SECRET
        sync: false
      - key: REDIRECT_URI
        sync: false  # e.g., https://remixify.onrender.com/accounts/spotify/login/callback/
      - key: SITE_ID
        value: "1"
      - key: DATABASE_URL
        fromDatabase:
          name: remixify-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: remixify-redis
          type: redis
          property: connectionString
      - key: PYTHON_VERSION
        value: "3.11"

  # ============ Celery Worker ============
  - type: worker
    name: remixify-celery
    runtime: docker
    dockerfilePath: ./Dockerfile
    dockerContext: .
    repo: https://github.com/kwakubiney/remixify
    branch: master
    autoDeploy: true
    
    # Override the Docker CMD for Celery
    dockerCommand: celery -A main worker -l info --concurrency=2
    
    plan: starter
    
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: main.settings.prod_settings
      - key: DJANGO_SECRET_KEY
        sync: false
      - key: SPOTIFY_CLIENT_ID
        sync: false
      - key: SPOTIFY_CLIENT_SECRET
        sync: false
      - key: REDIRECT_URI
        sync: false
      - key: SITE_ID
        value: "1"
      - key: DATABASE_URL
        fromDatabase:
          name: remixify-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: remixify-redis
          type: redis
          property: connectionString

  # ============ Redis ============
  - type: redis
    name: remixify-redis
    plan: starter  # or 'free'
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []  # Allow all (internal only)

# ============ Database ============
databases:
  - name: remixify-db
    plan: starter  # or 'free'
    databaseName: remixify
    user: remixify
